name: Deploy to Cloud Run

on:
  push:
    branches:
      - main

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  SERVICE_NAME: invoice-processor

jobs:
  # 1. テストジョブ (デプロイ前に必ず実行)
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run Pytest
        env:
          # テスト用のダミー環境変数 (外部アクセスしないため値は何でもOK)
          APP_ENV: test
          GOOGLE_CLOUD_PROJECT: test-project
          SLACK_WEBHOOK_URL: https://hooks.slack.com/services/test/test/test
        run: pytest tests/

  # 2. デプロイジョブ (テスト成功時のみ実行)
  deploy:
    name: Deploy to Cloud Run
    runs-on: ubuntu-latest
    needs: test # テスト成功を必須にする
    if: github.ref == 'refs/heads/main' # mainブランチのみデプロイ
    permissions:
      contents: "read"
      id-token: "write"

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # 認証: Service Account Key (JSON) を使用
      - name: Google Auth
        uses: "google-github-actions/auth@v2"
        with:
          credentials_json: "${{ secrets.GCP_SA_KEY }}"

      # デプロイ: ソースコードから直接ビルド & デプロイ
      - name: Deploy to Cloud Run
        uses: "google-github-actions/deploy-cloudrun@v2"
        with:
          service: ${{ env.SERVICE_NAME }}
          region: asia-northeast1
          source: .
          # API制限保護: max-instances=20
          # メモリ増強: 巨大な添付ファイル(PDF)対策で 1Gi (約1GB)
          flags: "--max-instances=20 --memory=1Gi --cpu=1"
          env_vars: |
            APP_ENV=production
            GOOGLE_CLOUD_PROJECT=${{ secrets.GCP_PROJECT_ID }}
            TARGET_LABEL=TARGET
            GMAIL_CLIENT_ID=${{ secrets.GMAIL_CLIENT_ID }}
            GMAIL_CLIENT_SECRET=${{ secrets.GMAIL_CLIENT_SECRET }}
            GMAIL_REFRESH_TOKEN=${{ secrets.GMAIL_REFRESH_TOKEN }}
            ALLOWED_DOMAINS=${{ secrets.ALLOWED_DOMAINS }}
            SUBJECT_KEYWORDS=${{ secrets.SUBJECT_KEYWORDS }}
            SLACK_WEBHOOK_URL=${{ secrets.SLACK_WEBHOOK_URL }}
            PROCESSED_LABEL_NAME=INVOICE_PROCESSED
            ERROR_LABEL_NAME=INVOICE_ERROR
