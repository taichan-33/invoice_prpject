# 本番環境 検証手順書 (安全なテスト方法)

本番環境 (Google Cloud) にデプロイした後、既存の大量のメール（3 万件など）に影響を与えずに、安全に動作確認を行うための手順です。

## 🛡 戦略: ラベルによる隔離 (カナリアテスト)

本番稼働用のラベル（例: `TARGET`）とは別の、**テスト専用ラベル（例: `TEST_VERIFY`）** を一時的に監視対象に設定することで、本番メールを一切処理させずにテストを行います。

---

## 1. Cloud Run の設定変更（テストモードへ）

1.  **Google Cloud Console** にアクセスし、[Cloud Run] のページを開きます。
2.  サービス `invoice-processor` を選択します。
3.  画面上部の **[リビジョンの編集とデプロイ]** をクリックします。
4.  **[コンテナ]** タブ内の **[環境変数]** セクションを探します。
5.  変数 `TARGET_LABEL` の値を変更します。
    - 変更前: `TARGET` (または本来の監視ラベル)
    - **変更後: `TEST_VERIFY`**
6.  画面下部の **[デプロイ]** をクリックします。
    - 数分で新しいリビジョンが稼働します。これ以降、システムは `TEST_VERIFY` ラベルが付いたメールだけを探しに行きます。

---

## 2. 動作確認の実施

1.  **テストメールの準備**
    - ご自身のメールアドレスから、本番の受信トレイ宛にメールを送ります。
    - 件名: `【テスト】請求書送付` (キーワードが含まれるように)
    - 添付: テスト用の PDF などを添付
2.  **ラベルの付与**
    - Gmail を開き、受信したテストメールに手動でラベル **`TEST_VERIFY`** を付けます。
    - (ラベルがない場合は新規作成してください)
3.  **処理の確認**
    - **Slack:** 通知が届くか確認します。
    - **Gmail:** 数分後、メールのラベルが `TEST_VERIFY` から `INVOICE_PROCESSED` (処理済み) に変わっているか確認します。
    - **Log:** Cloud Logging でエラーが出ていないか確認します。

---

## 3. テストデータの削除 (お掃除)

テストが完了したら、本番データに混ざらないようにテストデータを消しておきましょう。

### BigQuery のデータ削除

BigQuery コンソールで以下の SQL を実行し、テストで記録された行を削除します。
※ `your-project-id` は実際のプロジェクト ID に置き換えてください。

```sql
-- テストで投入した特定のメッセージID、またはファイル名で削除
DELETE FROM `your-project-id.invoice_data.invoice_log`
WHERE message_id = 'テストメールのメッセージID'
-- もしくは、今日の日付かつ特定の件名で削除
-- WHERE DATE(received_at) = CURRENT_DATE() AND subject LIKE '%【テスト】%';
```

### GCS のデータ削除 (任意)

Cloud Storage ブラウザから、`invoice-archive-XXX` バケット内のテストファイルを削除します。

---

## 4. 本番運用への切り戻し

テストで問題がないことが確認できたら、本番稼働を開始します。

1.  **Cloud Run の設定を戻す**

    - 手順 1 と同様に [リビジョンの編集とデプロイ] を開き、`TARGET_LABEL` を本来の値 **`TARGET`** に戻してデプロイします。
    - **注意:** デプロイ完了と同時に、溜まっていた 3 万件のメールの処理が（スケジュール実行のタイミングで）順次開始されます。

2.  **完了**
    - これにて本番運用開始です！
