# テスト仕様書 & 実行ガイド

本プロジェクトにおける自動テストの概要、実行方法、および各テストコードの意図について解説します。

## 1. テストの実行方法

### ローカルでの実行

プロジェクトルートで以下のコマンドを実行します。

```bash
# 依存ライブラリのインストール（初回のみ）
pip install -r requirements.txt

# テスト実行
pytest tests/
```

### CI (GitHub Actions) での実行

GitHub Actions により、`main` ブランチへのプルリクエストやマージのたびに自動実行されます。

- 設定ファイル: `.github/workflows/deploy.yml`
- テストが失敗すると、Cloud Run へのデプロイはブロックされます（安全のため）。

---

## 2. テスト構成 (tests/)

| ファイル名          | 区分       | 役割                                                                                                           |
| ------------------- | ---------- | -------------------------------------------------------------------------------------------------------------- |
| `test_parser.py`    | 単体テスト | Gmail API の複雑な JSON レスポンスから、必要な情報（送信者、添付ファイル等）が正しく抽出できるかを検証します。 |
| `test_filtering.py` | 単体テスト | 送信者ドメインや件名キーワードによるフィルタリングロジック（許可/拒否）が正しく機能するか検証します。          |
| `test_processor.py` | 統合テスト | メールの取得から GCS 保存、BigQuery 記録、ラベル変更までの一連の流れ（パイプライン）を検証します。             |
| `conftest.py`       | 設定       | 各テスト共通の設定やモック（環境変数の注入など）を管理します。                                                 |

---

## 3. 各テストの詳細解説

### ✅ test_parser.py (解析ロジック)

Gmail API のレスポンス形式は複雑なため、以下のパターンを網羅してテストしています。

- **正常系:** 送信者名とアドレスが両方ある場合 (`Amazon <info@amazon...>`)
- **アドレスのみ:** 名前がない場合 (`admin@google.com`) にアドレスを名前として扱うか
- **添付ファイル:** 添付ファイルがある場合、ファイル名やサイズが正しく取得できるか

### ✅ test_filtering.py (フィルタリング)

不正なメールを弾き、重要なメールを通すための「門番」のテストです。

- **OR ロジックの検証:** 「ドメインが許可リストにある」**または**「件名にキーワード（請求書など）が入っている」場合に許可されるか。
- **大文字・小文字:** `INVOICE` と `invoice` を同一視して正しく判定できるか。
- **拒否確認:** リストにないドメインかつ、件名も無関係なメールが `False` (拒否) になるか。

### ✅ test_processor.py (処理フロー)

実際の外部サービス（Gmail, GCS, BigQuery）には接続せず、**モック (Mock)** を使って安全にテストします。

- **正常系フロー:**
  1.  メール詳細を取得
  2.  フィルタ通過
  3.  GCS へアップロード（モック）呼び出し
  4.  BigQuery へインサート（モック）呼び出し
  5.  **ラベル変更（TARGET → PROCESSED）呼び出し**
- **複数添付ファイルの処理:**
  - 1 通に複数のファイルがある場合、全て処理されるか。
  - **ファイル名重複回避:** 同じ名前のファイル（例: `data.pdf` が 2 つ）があっても、連番（`_1`, `_2`）が付与されて別々に保存されるか。
- **拒否フロー:** フィルタで弾かれた場合、GCS や BigQuery への保存が行われないこと。
- **添付なし:** 添付ファイルがないメールは処理をスキップすること。

---

## 4. モック (Mock) について

`test_processor.py` では `unittest.mock` を使用しています。
これにより、テスト実行のたびに実際に Google Cloud にファイルをアップロードしたり、Slack 通知を飛ばしたりすることなく、ロジックの正しさだけを検証できます。

```python
# 例: GCSへの保存メソッドをモック（偽装）する
mock_storage.save_file.return_value = "https://fake-url.com"

# テスト実行後に、「save_file メソッドが1回呼ばれたか？」を検証
assert mock_storage.save_file.call_count == 1
```
